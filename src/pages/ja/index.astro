---
import Layout from '~/layouts/PageLayout_PochomLab_Ja.astro';
import Hero from '~/components/widgets/Hero_PochomLab.astro';
import Note from '~/components/widgets/Note.astro';

import { getCollection } from 'astro:content';

const metadata = {
  title: 'PochomLab - ç”ŸæˆAIã¨çµµæ›¸åˆ¶ä½œã‚’è»¸ã«ã€å‰µä½œãƒ»æŠ€è¡“ãƒ»IPæˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€æœªæ¥ã¸æ¥ç¶šã™ã‚‹ãƒ©ãƒœ',
  ignoreTitleTemplate: true,
};

const ANNOUNCE = {
  enabled: false,
  title: 'ãŠçŸ¥ã‚‰ã›',
  description: 'ğŸ† Guinness World Records ç”³è«‹ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
};

const entries = [
  {
    title: 'ğŸ“™ çµµæ›¸',
    desc: 'AIã¨ä¸€ç·’ã«æã„ãŸã€ãŸã¾ã—ã„ã®ç¯ã®è¨˜éŒ²ã€‚',
    href: '/ja/egaki-sho',
    badge: 'WORK',
  },
  {
    title: 'ğŸ“šï¸ ZINEï¼ˆçµµæ›¸å‰µã‚ã†ã‚ˆï¼ZINEï¼‰',
    desc: 'å‰µä½œãƒ»æŠ€è¡“ãƒ»å‡ºç‰ˆã®â€œå®Ÿè£…ãƒ­ã‚°â€ã‚’ã¾ã¨ã‚ã‚‹ã€‚',
    href: '/ja/zine/egaki-sho-create',
    badge: 'ZINE',
  },
  {
    title: 'ğŸŒ³ 307ã®åº­',
    desc: 'ç¯ã‚’æŒã¡å¯„ã‚‹å ´æ‰€ã€‚å‚åŠ è€…ã®è¨˜éŒ²ã¨ä½œå“ã®åº­ã€‚',
    href: '/ja/garden-307',
    badge: 'COMMUNITY',
  },
  {
    title: 'ğŸ« ã‚¤ãƒ™ãƒ³ãƒˆ',
    desc: 'å‡ºå±•ãƒ»é ’å¸ƒãƒ»ãƒªãƒªãƒ¼ã‚¹ã®äºˆå®šã¨è¨˜éŒ²ã€‚',
    href: '/ja/events',
    badge: 'EVENTS',
  },
  {
    title: 'ğŸ“ƒ Log',
    desc: 'åˆ¶ä½œãƒ»å®Ÿè£…ãƒ»åˆ¤æ–­ã®ãƒ­ã‚°ãƒ–ãƒƒã‚¯ã€‚',
    href: '/ja/log',
    badge: 'LOG',
  },
  {
    title: 'ğŸ”° ã¯ã˜ã‚ã«',
    desc: 'PochomLabã®ç›®çš„ã¨æ­©ãæ–¹ã€‚',
    href: '/ja/about',
    badge: 'START',
  },
];

// --- RSSã¨åŒç­‰ã®ã€Œæœ€æ–°æ›´æ–°ã€ãƒ­ã‚¸ãƒƒã‚¯
type Kind = 'Event' | 'Garden' | 'Log';

type LatestUpdate = {
  title: string;
  date: Date;
  summary: string;
  href: string;
  kind: Kind;
};

type FeedItem = {
  title: string;
  description?: string;
  link: string;
  pubDate: Date;
  categories: string[]; // ['Event'] | ['Garden'] | ['Log', 'ja']
};

function rank(it: FeedItem) {
  if (it.categories.includes('Event')) return 0;
  if (it.categories.includes('Garden')) return 1;
  return 2; // Log
}

function sortItems(a: FeedItem, b: FeedItem) {
  const d = b.pubDate.getTime() - a.pubDate.getTime();
  if (d !== 0) return d;
  return rank(a) - rank(b);
}

const [events, garden, logsJa] = await Promise.all([
  getCollection('events', (e) => !e.data.draft),
  getCollection('garden307', (g) => !g.data.draft),
  getCollection('log-ja', (p) => !p.data.draft),
]);

const eventItems: FeedItem[] = events.map((e) => ({
  title: e.data.title,
  description: [e.data.location, e.data.venue].filter(Boolean).join(' / ') || undefined,
  link: `/ja/events#${e.slug}`,
  pubDate: e.data.date,
  categories: ['Event'],
}));

const gardenItems: FeedItem[] = garden.map((g) => ({
  title: "ğŸ™‚" + g.data.title,
  description: g.data.description ?? g.data.comment,
  link: `/ja/garden-307#${g.slug}`,
  pubDate: g.data.date,
  categories: ['Garden'],
}));

const logItems: FeedItem[] = logsJa.map((p) => ({
  title: p.data.title,
  description: p.data.summary,
  link: `/ja/log/${p.slug}`,
  pubDate: p.data.date,
  categories: ['Log', 'ja'],
}));

const latestUpdates = [...eventItems, ...gardenItems, ...logItems]
  .sort(sortItems)
  .slice(0, 3)
  .map(
    (i) =>
      ({
        title: i.title,
        date: i.pubDate,
        summary: i.description ?? '',
        href: i.link,
        kind: i.categories.includes('Event') ? 'Event' : i.categories.includes('Garden') ? 'Garden' : 'Log',
      }) as LatestUpdate
  );

function fmtDate(d: Date) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function kindLabel(kind: 'Event' | 'Garden' | 'Log') {
  if (kind === 'Event') return 'EVENT';
  if (kind === 'Garden') return 'GARDEN';
  return 'LOG';
}
---

<Layout metadata={metadata}>
  <!-- Hero Widget ******************* -->

  <Hero lightUrl="/images/pochomlab-hero-light-jp.jpg" darkUrl="/images/pochomlab-hero-dark-jp.jpg">
    <Fragment slot="title">
      AIã§æãã€<br />
      <span class="text-[#FF5B50] dark:text-[#FFB74D]">ãŸã¾ã—ã„ã®ç¯ã€‚</span>
    </Fragment>

    <Fragment slot="subtitle">
      ç”ŸæˆAIã¨çµµæ›¸åˆ¶ä½œã‚’è»¸ã«ã€<br />
      å‰µä½œãƒ»æŠ€è¡“ãƒ»IPæˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€æœªæ¥ã¸æ¥ç¶šã™ã‚‹ãƒ©ãƒœã€‚
    </Fragment>
  </Hero>

  {ANNOUNCE.enabled && <Note title={ANNOUNCE.title} description={ANNOUNCE.description} />}

  <!-- Feature Entry (6 cards) -->
  <section class="py-16 md:py-20 border-t border-neutral-200/70 dark:border-neutral-800/70">
    <div class="container mx-auto max-w-5xl px-4">
      <div class="mb-10 text-center">
        <h2 class="font-serif text-2xl md:text-3xl text-neutral-900 dark:text-neutral-50">PochomLabã®å…¥å£</h2>
        <p class="mt-3 text-neutral-600 dark:text-neutral-300">ã¾ãšã¯ã“ã“ã‹ã‚‰ã€‚ç¯ã®è¨˜éŒ²ã€åˆ¶ä½œãƒ­ã‚°ã€ãã—ã¦åº­ã¸ã€‚</p>
      </div>

      <div class="grid gap-6 md:grid-cols-2">
        {
          entries.map((e) => (
            <a
              href={e.href}
              class="group rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm transition
                   hover:-translate-y-0.5 hover:shadow-md
                   dark:border-neutral-800 dark:bg-neutral-900/40"
            >
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h3 class="font-serif text-xl text-neutral-900 dark:text-neutral-50">{e.title}</h3>
                  <p class="mt-2 text-sm leading-relaxed text-neutral-600 dark:text-neutral-300">{e.desc}</p>
                </div>

                <span
                  class="shrink-0 rounded-full border border-neutral-200 bg-neutral-50 px-3 py-1 text-xs tracking-widest text-neutral-700
                       dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-200"
                >
                  {e.badge}
                </span>
              </div>

              <div class="mt-4 text-sm text-neutral-500 group-hover:text-neutral-900 dark:text-neutral-400 dark:group-hover:text-neutral-100">
                é–‹ã â†’
              </div>
            </a>
          ))
        }
      </div>

      <!-- small CTA -->
      <div
        class="mt-12 rounded-2xl border border-neutral-200 bg-neutral-50 p-6 text-center
                  dark:border-neutral-800 dark:bg-neutral-900/30"
      >
        <p class="text-neutral-700 dark:text-neutral-200">
          åˆ¶ä½œã®è£å´ã‚’è¿½ã†ãªã‚‰ ğŸ“šï¸
          <a href="/ja/zine/egaki-sho-create" class="underline underline-offset-4"> ZINE </a>
          ï¼ˆçµµæ›¸å‰µã‚ã†ã‚ˆï¼ZINEï¼‰ã¸ã€‚ ä½œå“ã‹ã‚‰å…¥ã‚‹ãªã‚‰ğŸ“™
          <a href="/ja/egaki-sho" class="underline underline-offset-4"> çµµæ›¸ </a>ã¸ã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Latest Log Entries -->
  <section class="py-14 border-t border-neutral-200/70 dark:border-neutral-800/70">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="mb-8 flex items-end justify-between gap-4">
        <div>
          <h2 class="font-serif text-xl md:text-2xl text-neutral-900 dark:text-neutral-50">æœ€æ–°æ›´æ–°</h2>
          <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-300">Events / 307ã®åº­ / Log ã‹ã‚‰ã€ç›´è¿‘ã®3ä»¶ã€‚</p>
        </div>

        <a
          href="/ja/log"
          class="text-sm text-neutral-600 hover:text-neutral-900 dark:text-neutral-300 dark:hover:text-neutral-50"
        >
          Logã‚’è¦‹ã‚‹ â†’
        </a>
      </div>

      <div class="grid gap-6 md:grid-cols-3">
        {
          latestUpdates.map((p) => (
            <a
              href={p.href}
              class="group rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm transition
               hover:-translate-y-0.5 hover:shadow-md
               dark:border-neutral-800 dark:bg-neutral-900/40"
            >
              <div class="flex items-start justify-between gap-4">
                <time class="text-xs text-neutral-500 dark:text-neutral-400">{fmtDate(p.date)}</time>
                <span
                  class="rounded-full border border-neutral-200 bg-neutral-50 px-3 py-1 text-xs tracking-widest text-neutral-700
                   dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-200"
                >
                  {kindLabel(p.kind)}
                </span>
              </div>

              <h3 class="mt-3 font-serif text-lg text-neutral-900 dark:text-neutral-50">{p.title}</h3>

              <p class="mt-2 text-sm leading-relaxed text-neutral-600 dark:text-neutral-300 line-clamp-2">{p.summary}</p>

              <div class="mt-4 text-sm text-neutral-500 group-hover:text-neutral-900 dark:text-neutral-400 dark:group-hover:text-neutral-100">
                é–‹ã â†’
              </div>
            </a>
          ))
        }
      </div>
    </div>
  </section>
</Layout>
